{% if multi_stage %}
FROM maven:3.8-openjdk-11 AS builder

WORKDIR /app
COPY pom.xml .
RUN mvn dependency:go-offline

COPY . .
RUN mvn package -DskipTests

FROM {{ base_image }}
WORKDIR /app

COPY --from=builder /app/target/*.jar app.jar

EXPOSE {{ port }}

CMD ["java", "-jar", "app.jar"]
{% else %}
{% extends "base.dockerfile.j2" %}

{% block setup %}
{% if analysis.dependency_files.get("pom.xml") %}
COPY pom.xml .
RUN mvn dependency:go-offline

COPY . .
RUN mvn package -DskipTests
{% else %}
COPY . .
RUN ./gradlew build
{% endif %}
{% endblock %}

{% block command %}
{% if analysis.dependency_files.get("pom.xml") %}
CMD ["java", "-jar", "target/*.jar"]
{% else %}
CMD ["java", "-jar", "build/libs/*.jar"]
{% endif %}
{% endblock %}
{% endif %}
