{% if multi_stage %}
FROM rust:1.70 AS builder

WORKDIR /app
COPY Cargo.toml Cargo.lock ./
RUN cargo fetch

COPY . .
RUN cargo build --release

FROM debian:bullseye-slim
RUN apt-get update && apt-get install -y ca-certificates && rm -rf /var/lib/apt/lists/*
WORKDIR /app

COPY --from=builder /app/target/release/* .

EXPOSE {{ port }}

CMD ["./main"]
{% else %}
{% extends "base.dockerfile.j2" %}

{% block setup %}
COPY Cargo.toml Cargo.lock ./
RUN cargo fetch

COPY . .
RUN cargo build --release
{% endblock %}

{% block command %}
CMD ["./target/release/main"]
{% endblock %}
{% endif %}
